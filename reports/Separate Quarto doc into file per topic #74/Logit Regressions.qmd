---
title: "Model performance for `r params$run_id`"
execute:
  echo: false
  warning: false
format:
  html:
    embed-resources: true
    toc: true
    toc_float: true
    fig-align: center
    fontsize: 12pt
editor: source
params:
  run_id: 2023-03-14-clever-damani
  year: '2023'
---
```{r}
library(knitr)
source("Setup_File.R")
```

## Logit Regressions

All covariates regressed on sale status - significance indicates a non-random effect on the likelihood of a sale ceterus paribus. Sample is universe of single family parcels from the past two years, excluding some parcels with incomplete characteristics.

```{r logit}
remove <-
  names(sf_parcels %>% rename_with(~ gsub(" |-", "_", .x)) %>%
    select(where(is.factor))) %>%
  grep(
    "Sale|Township|Apartments|Single|Commercial",
    .,
    invert = TRUE,
    value = TRUE
  )
fmla <- as.formula(paste0("Sale ~ ", paste(gsub(" |-", "_", vars), collapse = "+")))
logit <- glm(fmla,
  data = logit_parcels %>%
    rename_with(~ gsub(" |-", "_", .x)),
  family = "binomial"
)
sample_size <- logit$df.null
county_logit <- logit %>%
  broom::tidy() %>%
  mutate(
    p.value = paste0(scales::pvalue(p.value), (stars.pval(p.value))),
    term = gsub("_", " ", gsub(paste(remove, collapse = "|"), "", term))
  ) %>%
  kable(
    caption = paste0(
      "Sample size: ",
      format(sample_size, big.mark = ","),
      " single-family parcels"
    ),
    col.names = c("Predictor", "β", "SE", "t", "p"),
    digits = c(0, 5, 5, 3, 0),
    align = c("l", "r", "c", "r", "l"),
    padding = 5L
  ) %>%
  add_footnote("p-value notation: 0-0.001 = ***, 0.001-0.01 = **, 0.01-0.05 = *, 0.05-0.1 = .",
    notation = "none"
  ) %>%
  kable_styling("striped",
    fixed_thead = TRUE,
    html_font = "Consolas"
  ) %>%
  pack_rows("Type of Residence", 12, 20) %>%
  pack_rows("Cathedral Ceiling", 21, 22) %>%
  pack_rows("Attic Finish", 23, 25) %>%
  pack_rows("Garage 1 Attached", 26, 27) %>%
  pack_rows("Garage 1 Area Included", 28, 29) %>%
  pack_rows("Garage 1 Size", 30, 37) %>%
  pack_rows("Garage 1 Ext. Wall Material", 38, 41) %>%
  pack_rows("Attic Type", 42, 44) %>%
  pack_rows("Basement Type", 45, 48) %>%
  pack_rows("Exterior Wall Material", 49, 51) %>%
  pack_rows("Central Heating", 52, 55) %>%
  pack_rows("Basement Finish", 56, 58) %>%
  pack_rows("Roof Material", 59, 64) %>%
  pack_rows("Porch", 65, 66) %>%
  pack_rows("Central Air Conditioning", 67, 68) %>%
  pack_rows("Design Plan", 69, 70) %>%
  pack_rows("Recent Renovation", 71, 71)
logits <- logit_parcels %>%
  split(.$`Meta Township Name`) %>%
  sapply(function(x) {
    if (nrow(x) < 1000) {
      trim_vars <- grep("Renovation", vars, value = TRUE, invert = TRUE)
      fmla <- as.formula(paste0("Sale ~ ", paste0(gsub(
        " |-", "_", trim_vars
      ), collapse = "+")))
      glm(fmla,
        data = x %>%
          rename_with(~ gsub(" |-", "_", .x)),
        family = "binomial"
      ) %>%
        broom::tidy() %>%
        mutate(
          p.value = paste0(scales::pvalue(p.value), (stars.pval(p.value))),
          term = gsub("_", " ", term)
        ) %>%
        kable(
          col.names = c("Predictor", "β", "SE", "t", "p"),
          digits = c(0, 5, 5, 3, 0),
          align = c("l", "r", "c", "r", "l"),
          padding = 5L
        ) %>%
        add_footnote(
          "p-value notation: 0-0.001 = ***, 0.001-0.01 = **, 0.01-0.05 = *, 0.05-0.1 = .",
          notation = "none"
        ) %>%
        kable_styling(
          "striped",
          position = "left",
          fixed_thead = TRUE,
          html_font = "Consolas"
        )
    } else {
      fmla <- as.formula(paste0("Sale ~ ", paste0(gsub(" |-", "_", vars), collapse = "+")))
      glm(fmla,
        data = x %>%
          rename_with(~ gsub(" |-", "_", .x)),
        family = "binomial"
      ) %>%
        broom::tidy() %>%
        mutate(
          p.value = paste0(scales::pvalue(p.value), (stars.pval(p.value))),
          term = gsub("_", " ", term)
        ) %>%
        kable(
          col.names = c("Predictor", "β", "SE", "t", "p"),
          digits = c(0, 5, 5, 3, 0),
          align = c("l", "r", "c", "r", "l"),
          padding = 5L
        ) %>%
        add_footnote(
          "p-value notation: 0-0.001 = ***, 0.001-0.01 = **, 0.01-0.05 = *, 0.05-0.1 = .",
          notation = "none"
        ) %>%
        kable_styling(
          "striped",
          position = "left",
          fixed_thead = TRUE,
          html_font = "Consolas"
        )
    }
  }, simplify = FALSE)
```

::: panel-tabset
## County

```{r}
county_logit
```

## Barrington

```{r}
logits[["Barrington"]]
```

## Berwyn

```{r}
logits[["Berwyn"]]
```

## Bloom

```{r}
logits[["Bloom"]]
```

## Bremen

```{r}
logits[["Bremen"]]
```

## Calumet

```{r}
logits[["Calumet"]]
```

## Cicero

```{r}
logits[["Cicero"]]
```

## Elk Grove

```{r}
logits[["Elk Grove"]]
```

## Evanston

```{r}
logits[["Evanston"]]
```

## Hanover

```{r}
logits[["Hanover"]]
```

## Hyde Park

```{r}
logits[["Hyde Park"]]
```

## Jefferson

```{r}
logits[["Jefferson"]]
```

## Lake

```{r}
logits[["Lake"]]
```

## Lake View

```{r}
logits[["Lake View"]]
```

## Lemont

```{r}
logits[["Lemont"]]
```

## Leyden

```{r}
logits[["Leyden"]]
```

## Lyons

```{r}
logits[["Lyons"]]
```

## Maine

```{r}
logits[["Maine"]]
```

## New Trier

```{r}
logits[["New Trier"]]
```

## Niles

```{r}
logits[["Niles"]]
```

## North Chicago

```{r}
logits[["North Chicago"]]
```

## Northfield

```{r}
logits[["Northfield"]]
```

## Norwood Park

```{r}
logits[["Norwood Park"]]
```

## Oak Park

```{r}
logits[["Oak Park"]]
```

## Orland

```{r}
logits[["Orland"]]
```

## Palatine

```{r}
logits[["Palatine"]]
```

## Palos

```{r}
logits[["Palos"]]
```

## Proviso

```{r}
logits[["Proviso"]]
```

## Rich

```{r}
logits[["Rich"]]
```

## River Forest

```{r}
logits[["River Forest"]]
```

## Riverside

```{r}
logits[["Riverside"]]
```

## Rogers Park

```{r}
logits[["Rogers Park"]]
```

## Schaumburg

```{r}
logits[["Schaumburg"]]
```

## South Chicago

```{r}
logits[["South Chicago"]]
```

## Stickney

```{r}
logits[["Stickney"]]
```

## Thornton

```{r}
logits[["Thornton"]]
```

## West Chicago

```{r}
logits[["West Chicago"]]
```

## Wheeling

```{r}
logits[["Wheeling"]]
```

## Worth

```{r}
logits[["Worth"]]
```
:::
