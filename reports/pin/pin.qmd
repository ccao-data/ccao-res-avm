---
title: "PIN: `r params$pin`"
subtitle: "Run ID: `r params$run_id`"
date: "`r Sys.Date()`"
author: "Cook County Assessor's Office Data Department"
execute:
  echo: false
  warning: false
format:
  html:
    embed-resources: true
    toc: true
    toc_float: true
    fig-align: center
    fontsize: 12pt
editor: source
params:
  run_id: "2024-01-07-great-ida"
  year: "2024"
  pin: "28011040250000"
---

{{< include ../_setup.qmd >}}

```{r pin_checks}
target_pin <- ccao::pin_clean(params$pin)

if (nchar(target_pin) != 14) {
  stop("Invalid PIN: must be 14 characters long")
}

if (!target_pin %in% assessment_card$meta_pin) {
  stop("Invalid PIN: not found in assessment data")
}
```

```{r pin_setup}
noctua_options(cache_size = 10)
con <- dbConnect(noctua::athena())

res_chars <- dbGetQuery(
  conn = con,
  sprintf("SELECT pin, year, pin10, class, char_yrblt, char_bldg_sf, char_beds, char_fbath, char_hbath, char_air, char_type_resd, char_rooms FROM default.vw_card_res_char WHERE CAST(year AS INTEGER) > 2020 AND pin = '%s'", params$pin)
)

working_data <- dbGetQuery(
  conn = con,
  sprintf("SELECT * FROM default.vw_pin_value WHERE CAST(year AS INTEGER) > 2020 AND pin = '%s'", params$pin)
)

hie_data_subset <- hie_data %>%
  filter(hie_last_year_active >= params$year) %>%
  mutate(hie = TRUE)
```

## Topline Characteristics

```{r pin_topline_characteristics, results= 'asis'}
table1 <- assessment_pin %>%
  left_join(hie_data_subset[, c("pin", "hie")], by = c("meta_pin" = "pin")) %>%
  mutate(hie = replace_na(hie, FALSE)) %>%
  filter(meta_pin == params$pin) %>%
  select('Final FMV' = pred_pin_final_fmv, 
         'Sale Date' = sale_recent_1_date, 
         'Sale Price' = sale_recent_1_price, 
         'Multicard Flag' = flag_pin_is_multicard, 
         'Missing Critical Value' = flag_char_missing_critical_value) %>%
  kable()  %>%
  kable_styling(
          "striped",
          position = "left",
          fixed_thead = TRUE,
          html_font = "Consolas"
        )


print(table1)
```



## Identify any Missing Data or Changes in Characteristics

```{r pin_changes_in_characteristics}
chars_wide <- res_chars %>%
  distinct(pin, year, .keep_all = TRUE) %>%
  arrange(year, decreasing = FALSE) %>%
  pivot_wider(
    names_from = year,
    values_from = -c(pin, year),
    names_sep = "_",
    id_cols = pin
  )

check_changes <- function(df, start_col) {
  cols <- lapply(df[, (start_col):(start_col + 3)], function(x) as.numeric(as.character(x)))


  change_exists <- apply(do.call(cbind, cols), 1, function(x) {
    x[is.na(x)] <- 0
    any(base::diff(x) != 0)
  })

  return(change_exists)
}

apply_changes_to_dataset <- function(dataset) {
  total_cols <- ncol(dataset)
  start_col <- 6 

  while (start_col <= (total_cols - 3)) {
    changes <- check_changes(dataset, start_col)

    first_col_name <- names(dataset)[start_col]
    modified_col_name <- gsub("\\d", "", first_col_name)

    new_col_name <- paste(modified_col_name, "change", sep = "")

    dataset[[new_col_name]] <- changes

    start_col <- start_col + 4
  }

  return(dataset)
}

modified_dataset <- apply_changes_to_dataset(chars_wide)

modified_dataset$missing_characteristics <- apply(modified_dataset[, 5:ncol(modified_dataset)], 1, function(x) any(is.na(x)))

missing_data_table <- modified_dataset %>%
  select(43:51) %>%
  rename('Year Built' = char_yrblt_change, 
         'Building SF' = char_bldg_sf_change,
         'Bedrooms' = char_beds_change,
         'Full Baths' = char_fbath_change,
         'Half Baths' = char_hbath_change,
         'Air' = char_air_change,
         'Type' = char_type_resd_change,
         'Rooms' = char_rooms_change,
         'Missing Characteristics' = missing_characteristics
         ) %>%
  kable()

missing_data_table
```

```{r _pin_shap_data_manipulation}
shap_df_filtered <- shap_df %>%
  left_join(
    assessment_card %>%
      mutate(meta_triad = ccao::town_get_triad(meta_township_code)) %>%
      select(meta_year, meta_pin, meta_card_num, meta_triad),
    by = c("meta_year", "meta_pin", "meta_card_num")
  ) %>%
  arrange(meta_pin, meta_card_num)


shap_predictors <- names(shap_df_filtered)
shap_predictors <- shap_predictors[!shap_predictors %in% c(
  "meta_year",
  "meta_pin",
  "meta_card_num",
  "pred_card_shap_baseline_fmv",
  "township_code",
  "meta_triad"
)]

assessment_card_filtered <- assessment_card %>%
  mutate(meta_triad = ccao::town_get_triad(meta_township_code)) %>%
  filter(meta_triad == run_triad_code) %>%
  arrange(meta_pin, meta_card_num)

townships_to_iterate <- shap_df_filtered %>%
  distinct(township_code) %>%
  pull() %>%
  as.character()

shap_idx_full_model <- which(
  assessment_card_filtered$meta_township_code %in% townships_to_iterate
)
```
## Individual Pin SHAP Results
```{r _pin_shap_viz}
shap_df_filtered <- shap_df_filtered %>%
  filter(meta_pin == params$pin)

assessment_card_filtered <- assessment_card_filtered %>%
  filter(meta_pin == params$pin)

shapviz::shapviz(
  object = shap_df_filtered %>%
    select(all_of(shap_predictors)) %>%
    slice(shap_idx_full_model) %>%
    as.matrix(),
  X = assessment_card_filtered %>%
    select(all_of(shap_predictors)) %>%
    slice(shap_idx_full_model),
  baseline = shap_df_filtered$pred_card_shap_baseline_fmv[1]
) %>%
  shapviz::sv_waterfall(
    max_display = 15L
  )
```

## Table of SHAP Values Grouped by Category
```{r pin_shap_table, results = "asis"}
shap_df_filtered_v2 <- shap_df_filtered %>%
  filter(meta_pin == params$pin) %>%
  select_if(is.numeric) %>%
  select(-c(township_code))

sum_columns_by_prefix_per_row <- function(df, prefix) {
  df %>%
    select(starts_with(prefix)) %>%
    rowSums(na.rm = TRUE)
}

Characteristics <- sum_columns_by_prefix_per_row(shap_df_filtered_v2, "char")

Census_Data <- sum_columns_by_prefix_per_row(shap_df_filtered_v2, "acs5")

Time <- sum_columns_by_prefix_per_row(shap_df_filtered_v2, "time")

Location <- sum_columns_by_prefix_per_row(shap_df_filtered_v2, "loc") + shap_df_filtered_v2$ccao_is_corner_lot

Proximity <- sum_columns_by_prefix_per_row(shap_df_filtered_v2, "prox")

School <- rowSums(shap_df_filtered_v2[, c("other_school_district_elementary_avg_rating", "other_school_district_secondary_avg_rating", "other_school_district_elementary_avg_rating", "other_school_district_secondary_avg_rating")], na.rm = TRUE)

Baseline <- shap_df_filtered$pred_card_shap_baseline_fmv

Meta <- sum_columns_by_prefix_per_row(shap_df_filtered_v2, "meta")

combined_sums <- data.frame(
    Baseline = dollar(shap_df_filtered_v2$pred_card_shap_baseline_fmv),
    Characteristics = dollar(sum_columns_by_prefix_per_row(shap_df_filtered_v2, "char")),
    Census_Data = dollar(sum_columns_by_prefix_per_row(shap_df_filtered_v2, "acs5")),
    Time = dollar(sum_columns_by_prefix_per_row(shap_df_filtered_v2, "time")),
    Location = dollar(sum_columns_by_prefix_per_row(shap_df_filtered_v2, "loc") + shap_df_filtered_v2$ccao_is_corner_lot),
    Proximity = dollar(sum_columns_by_prefix_per_row(shap_df_filtered_v2, "prox")),
    School = dollar(rowSums(shap_df_filtered_v2[, c("other_school_district_elementary_avg_rating", "other_school_district_secondary_avg_rating")])),
    Meta = dollar(sum_columns_by_prefix_per_row(shap_df_filtered_v2, "meta"))
) %>%
  kable(col.names = c("Baseline", "Characteristics", "Census Data", "Time", "Location", "Proximity", "School", "Meta"),
        align = 'l') %>% 
  kable_styling(
          "striped",
          position = "left",
          fixed_thead = TRUE,
          html_font = "Consolas"
        )

combined_sums
```


## Change in House Value over 3 Year Timeframe
```{r pin_change_in_house_value, results = 'asis'}
wider_data <- working_data %>%
  pivot_wider(
    names_from = year,
    values_from = -c(pin, year),
    names_sep = "_",
    id_cols = pin
  )

year_numeric <- as.numeric(params$year)
years <- (year_numeric - 4):year_numeric

# Create a vector of column names to select
cols_to_select <- c("pin", unlist(sapply(years, function(y) {
  c(paste0("mailed_tot_", y), paste0("certified_tot_", y), paste0("board_tot_", y))
})))

single_pin <- wider_data %>%
  select(contains(cols_to_select)) %>%
  mutate(
    across(contains("mailed"), ~ . * 10),
    across(contains("board"), ~ . * 10),
    across(contains("certified"), ~ . * 10)
) %>%
  inner_join(
    assessment_pin %>%
      select(meta_pin, pred_pin_final_fmv),
    by = c("pin" = "meta_pin")
  ) %>%
  select_if(~!all(is.na(.))) %>%
  select(-"pin")

single_pin <- single_pin %>%
  rename_with(~ str_replace_all(., "_", " ") %>%
                str_replace_all(., " tot", "") %>%
                str_to_title())

color_matrix <- matrix("none", nrow = nrow(single_pin), ncol = ncol(single_pin))

for (j in 3:ncol(single_pin)) {
  for (i in 1:nrow(single_pin)) {
    value <- single_pin[i, j]
    previous <- single_pin[i, j - 1]

    if (!is.na(value) && !is.na(previous) && previous != 0) {
      if (value > previous) {
        color_matrix[i, j] <- "green"
      } else if (value < previous) {
        color_matrix[i, j] <- "red"
      } else {
        color_matrix[i, j] <- "transparent"
      }
    } else {
      color_matrix[i, j] <- "gray"
    }
  }
}

single_pin <- single_pin %>%
  mutate_at(1:ncol(single_pin), scales::dollar)

display_df <- as.data.frame(lapply(single_pin, as.character), stringsAsFactors = FALSE)

expanded_color_matrix <- matrix("none", nrow = nrow(display_df), ncol = ncol(display_df))
expanded_color_matrix[, 1:ncol(color_matrix)] <- color_matrix

for (j in 1:ncol(display_df)) {
  for (i in 1:nrow(display_df)) {
    display_df[i, j] <- cell_spec(display_df[i, j], "html", background = expanded_color_matrix[i, j])
  }
}




kable_html <- kable(display_df, format = "html", escape = FALSE) %>%
  kable_styling(
          "striped",
          position = "left",
          fixed_thead = TRUE,
          html_font = "Consolas"
        )

kable_html
```
